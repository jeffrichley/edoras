"use strict";function initializeModel(e){var t=e.createList(),n=e.createList(),r=e.createList(),i=e.createList(),o=e.createList(),a=e.createList();e.getRoot().set("features",t),e.getRoot().set("stories",n),e.getRoot().set("iterations",r),e.getRoot().set("comments",i),e.getRoot().set("tasks",o),e.getRoot().set("acceptanceTests",a)}function onFileLoaded(e){Object.defineProperty(gapi.drive.realtime.CollaborativeString.prototype,"text",{set:function(e){return this.setText(e)},get:function(){return this.getText()}}),registerAllListeners(e),model=e.getModel(),features=e.getModel().getRoot().get("features"),stories=e.getModel().getRoot().get("stories"),iterations=e.getModel().getRoot().get("iterations"),comments=e.getModel().getRoot().get("comments"),tasks=e.getModel().getRoot().get("tasks"),acceptanceTests=e.getModel().getRoot().get("acceptanceTests"),postLoadCallback&&postLoadCallback(),console.log("received file")}function registerTypes(){edoras.Feature=function(){},edoras.Story=function(){},edoras.Iteration=function(){},edoras.Comment=function(){},edoras.Task=function(){},edoras.AcceptanceTest=function(){},gapi.drive.realtime.custom.registerType(edoras.Feature,"Feature"),gapi.drive.realtime.custom.registerType(edoras.Story,"Story"),gapi.drive.realtime.custom.registerType(edoras.Iteration,"Iteration"),gapi.drive.realtime.custom.registerType(edoras.Comment,"Comment"),gapi.drive.realtime.custom.registerType(edoras.Task,"Task"),gapi.drive.realtime.custom.registerType(edoras.AcceptanceTest,"AccptanceTest"),edoras.Feature.prototype.title=gapi.drive.realtime.custom.collaborativeField("title"),edoras.Feature.prototype.narrative=gapi.drive.realtime.custom.collaborativeField("narrative"),edoras.Feature.prototype.timestamp=gapi.drive.realtime.custom.collaborativeField("timestamp"),edoras.Iteration.prototype.title=gapi.drive.realtime.custom.collaborativeField("title"),edoras.Iteration.prototype.timestamp=gapi.drive.realtime.custom.collaborativeField("timestamp"),edoras.Story.prototype.title=gapi.drive.realtime.custom.collaborativeField("title"),edoras.Story.prototype.narrative=gapi.drive.realtime.custom.collaborativeField("narrative"),edoras.Story.prototype.effort=gapi.drive.realtime.custom.collaborativeField("effort"),edoras.Story.prototype.status=gapi.drive.realtime.custom.collaborativeField("status"),edoras.Story.prototype.timestamp=gapi.drive.realtime.custom.collaborativeField("timestamp"),edoras.Story.prototype.featureId=gapi.drive.realtime.custom.collaborativeField("featureId"),edoras.Story.prototype.iterationId=gapi.drive.realtime.custom.collaborativeField("iterationId"),edoras.Comment.prototype.narrative=gapi.drive.realtime.custom.collaborativeField("narrative"),edoras.Comment.prototype.ownerId=gapi.drive.realtime.custom.collaborativeField("ownerId"),edoras.Comment.prototype.commenterId=gapi.drive.realtime.custom.collaborativeField("commenterId"),edoras.Comment.prototype.timestamp=gapi.drive.realtime.custom.collaborativeField("timestamp"),edoras.Task.prototype.narrative=gapi.drive.realtime.custom.collaborativeField("narrative"),edoras.Task.prototype.storyId=gapi.drive.realtime.custom.collaborativeField("storyId"),edoras.Task.prototype.status=gapi.drive.realtime.custom.collaborativeField("status"),edoras.Task.prototype.timestamp=gapi.drive.realtime.custom.collaborativeField("timestamp"),edoras.AcceptanceTest.prototype.narrative=gapi.drive.realtime.custom.collaborativeField("narrative"),edoras.AcceptanceTest.prototype.storyId=gapi.drive.realtime.custom.collaborativeField("storyId"),edoras.AcceptanceTest.prototype.status=gapi.drive.realtime.custom.collaborativeField("status"),edoras.AcceptanceTest.prototype.timestamp=gapi.drive.realtime.custom.collaborativeField("timestamp")}function startRealtime(){var e=new rtclient.RealtimeLoader(realtimeOptions);e.start()}function registerAllListeners(e){registerListener(e,gapi.drive.realtime.EventType.OBJECT_CHANGED),registerListener(e,gapi.drive.realtime.EventType.VALUES_ADDED),registerListener(e,gapi.drive.realtime.EventType.VALUES_REMOVED),registerListener(e,gapi.drive.realtime.EventType.VALUES_SET)}function registerListener(e,t){e.getModel().getRoot().addEventListener(t,function(e){e.isLocal||rootScope.$digest()})}var rtclient=rtclient||{};rtclient.INSTALL_SCOPE="https://www.googleapis.com/auth/drive.install",rtclient.FILE_SCOPE="https://www.googleapis.com/auth/drive.file",rtclient.OPENID_SCOPE="openid",rtclient.REALTIME_MIMETYPE="application/json",rtclient.getParams=function(){var e={},t=window.location.search;if(t)for(var n=t.slice(1).split("&"),r=0;n.length>r;r++){var i=n[r].split("=");e[i[0]]=unescape(i[1])}return e},rtclient.params=rtclient.getParams(),rtclient.getOption=function(e,t,n){var r=void 0==e[t]?n:e[t];return void 0==r&&console.error(t+" should be present in the options."),r},rtclient.Authorizer=function(e){this.clientId=rtclient.getOption(e,"clientId"),this.userId=rtclient.params.userId,this.authButton=document.getElementById(rtclient.getOption(e,"authButtonElementId"))},rtclient.Authorizer.prototype.start=function(e){var t=this;gapi.load("auth:client,drive-realtime,drive-share",function(){t.authorize(e)})},rtclient.Authorizer.prototype.authorize=function(e){var t=this.clientId,n=this.userId,r=this,i=function(t){t&&!t.error?(r.authButton.disabled=!0,r.authButton.style.display="none",r.fetchUserId(e)):(r.authButton.disabled=!1,r.authButton.style.display="",r.authButton.onclick=o)},o=function(){gapi.auth.authorize({client_id:t,scope:[rtclient.INSTALL_SCOPE,rtclient.FILE_SCOPE,rtclient.OPENID_SCOPE],user_id:n,immediate:!1},i),console.log(t)};gapi.auth.authorize({client_id:t,scope:[rtclient.INSTALL_SCOPE,rtclient.FILE_SCOPE,rtclient.OPENID_SCOPE],user_id:n,immediate:!0},i)},rtclient.Authorizer.prototype.fetchUserId=function(e){var t=this;gapi.client.load("oauth2","v2",function(){gapi.client.oauth2.userinfo.get().execute(function(n){n.id&&(t.userId=n.id),e&&e()})})},rtclient.createRealtimeFile=function(e,t){gapi.client.load("drive","v2",function(){gapi.client.drive.files.insert({resource:{mimeType:rtclient.REALTIME_MIMETYPE,title:e}}).execute(t)})},rtclient.getFileMetadata=function(e,t){gapi.client.load("drive","v2",function(){gapi.client.drive.files.get({fileId:id}).execute(t)})},rtclient.parseState=function(e){try{var t=JSON.parse(e);return t}catch(n){return null}},rtclient.redirectTo=function(e,t){var n=[];e&&n.push("fileId="+e),t&&n.push("userId="+t),window.location.href=0==n.length?"/":"?"+n.join("&")},rtclient.RealtimeLoader=function(e){this.onFileLoaded=rtclient.getOption(e,"onFileLoaded"),this.initializeModel=rtclient.getOption(e,"initializeModel"),this.registerTypes=rtclient.getOption(e,"registerTypes",function(){}),this.autoCreate=rtclient.getOption(e,"autoCreate",!1),this.defaultTitle=rtclient.getOption(e,"defaultTitle","New Realtime File"),this.authorizer=new rtclient.Authorizer(e)},rtclient.RealtimeLoader.prototype.start=function(e){var t=this;this.authorizer.start(function(){t.registerTypes&&t.registerTypes(),e&&e(),t.load()})},rtclient.RealtimeLoader.prototype.load=function(){var parmObj=rtclient.params.state;if(console.log(parmObj),parmObj){var state=eval("["+parmObj+"]")[0];rtclient.params.fileId=state[0]}var fileId=rtclient.params.fileId,userId=this.authorizer.userId,state=rtclient.params.state,authorizer=this.authorizer,handleErrors=function(e){e.type==gapi.drive.realtime.ErrorType.TOKEN_REFRESH_REQUIRED?authorizer.authorize():e.type==gapi.drive.realtime.ErrorType.CLIENT_ERROR?(alert("An Error happened: "+e.message),window.location.href="/"):e.type==gapi.drive.realtime.ErrorType.NOT_FOUND&&(alert("The file was not found. It does not exist or you do not have read access to the file."),window.location.href="/")};if(fileId)return gapi.drive.realtime.load(fileId,this.onFileLoaded,this.initializeModel,handleErrors),void 0;if(state){var stateObj=rtclient.parseState(state);if("open"==stateObj.action)return fileId=stateObj.ids[0],userId=stateObj.userId,rtclient.redirectTo(fileId,userId),void 0}this.autoCreate&&this.createNewFileAndRedirect()},rtclient.RealtimeLoader.prototype.createNewFileAndRedirect=function(){var e=this;rtclient.createRealtimeFile(this.defaultTitle,function(t){t.id?rtclient.redirectTo(t.id,e.authorizer.userId):(console.error("Error creating file."),console.error(t))})};var edoras={},postLoadCallback=null,model=null,features=null,stories=null,iterations=null,comments=null,tasks=null,acceptanceTests=null,rootScope=null;angular.module("tracAppServices",[]).factory("DocTracker",["$rootScope",function(e){rootScope=e;var t={};return t.waitForDocs=function(e){model?e():postLoadCallback=e},t.getFeatureById=function(e){for(var t=features.asArray(),n=0;t.length>n;n++){var r=t[n];if(r.timestamp==e)return r}},t.getFeatures=function(){return features},t.addFeature=function(){var e=model.create(edoras.Feature);return e.timestamp=(new Date).getTime(),features.push(e),e},t.deleteFeature=function(e){for(var t=0;features.length>t;t++){var n=features.get(t);n.timestamp==e&&features.removeValue(n)}for(var t=0;stories.length>t;t++){var r=stories.get(t);r.featureId==e&&(r.featureId=void 0)}},t.getStories=function(){return stories},t.addStory=function(){var e=model.create(edoras.Story);return e.timestamp=(new Date).getTime(),e.status=1,stories.push(e),e},t.deleteStory=function(e){for(var t=0;stories.length>t;t++){var n=stories.get(t);n.timestamp==e&&stories.removeValue(n)}for(var t=0;tasks.length>t;t++){var r=tasks.get(t);r.storyId==e&&tasks.removeValue(r)}for(var t=0;acceptanceTests.length>t;t++){var i=acceptanceTests.get(t);i.storyId==e&&acceptanceTests.removeValue(i)}for(var t=0;comments.length>t;t++){var o=comments.get(t);o.owner==e&&comments.removeValue(o)}},t.getStoryById=function(e){for(var t=stories.asArray(),n=0;t.length>n;n++){var r=t[n];if(r.timestamp==e)return r}},t.getIterations=function(){return iterations},t.addIteration=function(){var e=model.create(edoras.Iteration);return e.timestamp=(new Date).getTime(),iterations.push(e),e},t.getIterationById=function(e){for(var t=iterations.asArray(),n=0;t.length>n;n++){var r=t[n];if(r.timestamp==e)return r}},t.getComments=function(){return comments},t.addComment=function(e,t){var n=model.create(edoras.Comment);n.timestamp=(new Date).getTime(),n.narrative=t,n.ownerId=e,comments.push(n)},t.getTasks=function(){return tasks},t.addTask=function(e,t){var n=model.create(edoras.Task);n.timestamp=(new Date).getTime(),n.narrative=t,n.storyId=e,n.status=1,tasks.push(n)},t.getAcceptanceTests=function(){return acceptanceTests},t.addAcceptanceTest=function(e,t){var n=model.create(edoras.AcceptanceTest);n.timestamp=(new Date).getTime(),n.narrative=t,n.storyId=e,n.status=1,acceptanceTests.push(n)},t}]);var realtimeOptions={clientId:"852711004421.apps.googleusercontent.com",authButtonElementId:"authorizeButton",initializeModel:initializeModel,autoCreate:!0,defaultTitle:"New Edoras Project File",onFileLoaded:onFileLoaded,registerTypes:registerTypes};angular.module("edorasApp",["tracAppServices"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/features",{templateUrl:"views/features.html",controller:"FeaturesCtrl"}).when("/feature/:featureId",{templateUrl:"views/feature.html",controller:"FeatureCtrl"}).when("/stories",{templateUrl:"views/stories.html",controller:"StoriesCtrl"}).when("/story/:storyId",{templateUrl:"views/story.html",controller:"StoryCtrl"}).when("/iterations",{templateUrl:"views/iterations.html",controller:"IterationsCtrl"}).when("/iteration/:iterationId",{templateUrl:"views/iteration.html",controller:"IterationCtrl"}).when("/overview",{templateUrl:"views/overview.html",controller:"OverviewCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("edorasApp").controller("MainCtrl",function(){});var module=angular.module("edorasApp");module.controller("FeaturesCtrl",["$scope","$location","DocTracker",function(e,t,n){n.waitForDocs(function(){e.features=n.getFeatures(),e.addFeature=function(){var e=n.addFeature(),r=e.timestamp;t.path("/feature/"+r)}})}]),module.controller("FeatureCtrl",["$scope","$routeParams","$location","DocTracker",function(e,t,n,r){r.waitForDocs(function(){var i=t.featureId;e.feature=r.getFeatureById(i),e.deleteFeature=function(){r.deleteFeature(i),n.path("/features")}})}]);var module=angular.module("edorasApp");module.controller("StoriesCtrl",["$scope","$location","DocTracker",function(e,t,n){n.waitForDocs(function(){e.stories=n.getStories(),e.addStory=function(){var e=n.addStory(),r=e.timestamp;t.path("/story/"+r)}})}]),module.controller("StoryCtrl",["$scope","$routeParams","$location","DocTracker",function(e,t,n,r){r.waitForDocs(function(){var i=t.storyId;e.story=r.getStoryById(i),e.effortOptions=[{label:"1",value:1},{label:"2",value:2},{label:"3",value:3},{label:"4",value:4},{label:"5",value:5}],e.statusOptions=[{label:"Not Started",value:1},{label:"In Progress",value:2},{label:"Ready for Testing",value:3},{label:"Passed Testing",value:4},{label:"Failed",value:5}],e.taskOptions=[{label:"Not Started",value:1},{label:"In Progress",value:2},{label:"Complete",value:3}],e.acceptanceOptions=[{label:"Untested",value:1},{label:"In Progress",value:2},{label:"Passed",value:3},{label:"Failed",value:4}],e.features=r.getFeatures(),e.iterations=r.getIterations(),e.comments=r.getComments(),e.tasks=r.getTasks(),e.acceptanceTests=r.getAcceptanceTests(),e.deleteStory=function(){r.deleteStory(i),n.path("/stories")},e.addComment=function(){e.newComment&&e.newComment.length>0&&(r.addComment(i,e.newComment),e.newComment=null)},e.addTask=function(){e.newTask&&e.newTask.length>0&&(r.addTask(i,e.newTask),e.newTask=null)},e.addAcceptanceTest=function(){e.newAcceptanceTest&&e.newAcceptanceTest.length>0&&(r.addAcceptanceTest(i,e.newAcceptanceTest),e.newAcceptanceTest=null)}})}]);var module=angular.module("edorasApp");module.controller("IterationsCtrl",["$scope","$location","DocTracker",function(e,t,n){n.waitForDocs(function(){e.iterations=n.getIterations(),e.addIteration=function(){var e=n.addIteration(),r=e.timestamp;t.path("/iteration/"+r)}})}]),module.controller("IterationCtrl",["$scope","$routeParams","DocTracker",function(e,t,n){n.waitForDocs(function(){var r=t.iterationId;e.iteration=n.getIterationById(r),e.stories=n.getStories(),e.removeStory=function(e){var t=n.getStoryById(e);t.iterationId=void 0}})}]);var module=angular.module("edorasApp");module.controller("OverviewCtrl",["$scope","DocTracker",function(e,t){t.waitForDocs(function(){e.tasks=t.getTasks(),e.acceptanceTests=t.getAcceptanceTests()})}]);